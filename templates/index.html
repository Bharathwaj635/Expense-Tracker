<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Smart Expense Tracker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>üí∞ Personal Expense Tracker</h1>
        <button id="darkModeToggle" class="mode-btn">üåì Switch Theme</button>
    </div>

    <div class="summary-section">
        <div class="sum-card filtered">
            <h3>Filtered Total</h3>
            <p class="amt">‚Çπ{{ "%.2f"|format(total) }}</p>
        </div>
        <div class="sum-card monthly">
            <h3>{{ current_month_name }} Total</h3>
            <div class="prog-wrapper">
                <div class="prog-bar" style="width: {{ (monthly_total/budget)*100 if monthly_total < budget else 100 }}%; 
                     background: {{ '#ff4757' if monthly_total > budget else '#2ed573' }};"></div>
            </div>
            <p>‚Çπ{{ monthly_total }} / ‚Çπ{{ budget }}</p>
        </div>
        <div class="chart-box">
            <canvas id="expenseChart"></canvas>
        </div>
    </div>

    <div class="card-box">
        <h3 id="formTitle">Add New Expense</h3>
        <form method="post" id="mainForm" class="grid-form">
            <input type="date" name="date" required id="f_date">
            <input type="text" name="category" placeholder="Category" required id="f_cat">
            <input type="number" step="0.01" name="amount" placeholder="Amount" required id="f_amt">
            <input type="text" name="description" placeholder="Description" required id="f_desc">
            <button type="submit" id="submitBtn">Add Expense</button>
        </form>
    </div>

    <div class="filter-bar">
        <form method="get" class="filter-flex">
            <select name="category">
                <option value="">All Categories</option>
                <option value="Food">Food</option>
                <option value="Travel">Travel</option>
                <option value="Rent">Rent</option>
                <option value="Bills">Bills</option>
            </select>
            <div class="date-inputs">
                <input type="date" name="start_date">
                <span>to</span>
                <input type="date" name="end_date">
            </div>
            <select name="sort">
                <option value="new">Newest First</option>
                <option value="old">Oldest First</option>
            </select>
            <button type="submit" class="apply-btn">Apply Filters</button>
            <a href="/" class="reset-link">Reset</a>
        </form>
    </div>

    <div class="table-card">
        <table>
            <thead>
                <tr><th>Date</th><th>Category</th><th>Amount</th><th>Description</th><th>Action</th></tr>
            </thead>
            <tbody>
                {% for row in expenses %}
                <tr class="row-anim">
                    <td>{{ row["date"] }}</td>
                    <td><span class="cat-tag">{{ row["category"] }}</span></td>
                    <td class="bold-amt">‚Çπ{{ row["amount"] }}</td>
                    <td>{{ row["description"] }}</td>
                    <td>
                        <button class="edit-action" onclick="prepareEdit({{ row['id'] }}, '{{ row['date'] }}', '{{ row['category'] }}', {{ row['amount'] }}, '{{ row['description'] }}')">Edit</button>
                        <a href="/delete/{{ row['id'] }}" class="del-action" onclick="return confirm('Delete item?')">Delete</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    // Dark Mode logic
    const modeBtn = document.getElementById("darkModeToggle");
    modeBtn.onclick = () => document.body.classList.toggle("dark-theme");

    // Chart logic
    const ctx = document.getElementById('expenseChart').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: {{ categories|safe }},
            datasets: [{
                data: {{ amounts|safe }},
                backgroundColor: ['#1e90ff', '#ff4757', '#ffa502', '#2ed573', '#a29bfe'],
                borderWidth: 0
            }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' }}}
    });

    // Edit logic
    function prepareEdit(id, date, cat, amt, desc) {
        document.getElementById('f_date').value = date;
        document.getElementById('f_cat').value = cat;
        document.getElementById('f_amt').value = amt;
        document.getElementById('f_desc').value = desc;
        document.getElementById('mainForm').action = "/edit/" + id;
        document.getElementById('formTitle').innerText = "Update Expense ‚úèÔ∏è";
        document.getElementById('submitBtn').innerText = "Update Now";
        document.getElementById('submitBtn').style.background = "#1e90ff";
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
</script>
</body>
</html>